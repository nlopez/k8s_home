apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: dui
  namespace: jobs
spec:
  schedule: '12 */1 * * *'
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          volumes:
          - name: dui
            iscsi:
              iqn: iqn.2014-09.com.radoncanyon:nas1:dui
              targetPortal: 192.168.220.149
              lun: 1
              fsType: ext4
          - name: dui-config
            secret:
              secretName: dui-config
          - name: dui-rclone-config
            secret:
              secretName: dui-rclone-config
          initContainers:
          - name: dui
            image: nlopez/dui:4
            env:
              - name: DUI_INI
                value: /dui/config/dui.ini
            volumeMounts:
            - name: dui
              mountPath: /dui
            - name: dui-config
              mountPath: /dui/config
              readOnly: true
          - name: rclone
            image: rclone/rclone:1.50.2
            args:
            - --config
            - /config/rclone.conf
            - copy
            - --progress
            - /dui/data
            - Nextcloud:/dui
            volumeMounts:
            - name: dui
              mountPath: /dui
              readOnly: true
            - name: dui-rclone-config
              mountPath: /config
              readOnly: true
          containers:
          - name: hc-ping
            image: buildpack-deps:bionic-curl
            command: ["/usr/bin/curl"]
            args:
            - --retry
            - '3'
            - https://hc-ping.com/4bb27667-5f75-46ed-ac59-a1a04dd54008
          restartPolicy: Never
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  creationTimestamp: null
  name: dui-config
  namespace: jobs
spec:
  encryptedData:
    dui.ini: AgCQNPLJPHeiW8evJLWGehzuDfswsdzVmZh6kjEttTD3qQ9yl9nUAiTgXCNUO7uigxcQmDW9jZYTp9GDBewkIn8nitxmIy+cVKWPNHXMVvcbntASCFTk68ifwQcyi1/u0EKQ3uzYHKbkkaLiPgAICl78Y7t+f2ne1/Gfzly4s5TMT3NV8s0lMIP1Ioj7HV4/cXMhkwU7uPJTLL/eUv/GZVqpsyfCmzmKtdk3sHba/t3GnFkWamwz0hnrFKqt5MtLehldARErhB+o9xxUSLq5/a8Y6fMGH9Q0FDfRBhYnD4A25I+TQlu7jmnAQS9bz13oMsUTaFTYRL680yqxrOWm5RNdip8M1Wg7TGANonrWo+wWgXjZJY1xRmWSC+oN8q+xDNnhS664MY3KvT+jC/v78kgPLWoc/xDTZ8RCd6Sfl4xGJvpk3OMJDZoB9Mi2o6ot4WuywXYWqg70gLfrKrU6wKV28y9RueX30K4MknopEmUyFfBAVU1rL5RDjBa0/sS+wCGG4v6CsHUa96uGjWcutCbTrJGcKSYfEMRuAGoypzxdLLbldtR90tz0JPL+H1qJQ+LzkFIZ0unlYL3AS866A/qxdPrVRYquQWSyo14L0qT3/x0ZN/roF2sprrJrIM5WXJ0hFRRwT1VmXJSWFRhw1we64nAtIUCmfUNO9dCkz3H23yU0+mv9xf7i48ID9ju45Kregf4vy/HhS6/ql8skHNVoRmSPLzZbp9fHFkAqvU36VNZ74drFec3QnsXnl78dKLR9EPvxRm4WMZQp8ZXRdaG9TTpaekjaTUeGkVAz8MatdBzUhg94IJVSz2zu+7Ag1qxetdrbUfKQ7/ZvQ/OG2WOHlnbYqzAoWxYNp5dz5TUnqzrLLyo6mnBDP1bmnRSRqOqAn2q+8k8d+LLkadP/g9VRU+d6qXpwPZFchmK1ikURgfxJgvqLXOUdaSiLwDV485BNDPXnO3mqv6MMCtOhGj3tzYhBtoa/C+E5Ht+DEqcMigHdnGt8k8ndNqafIiJO6zn7G25L8eXLYC9E4QHI0fTEiq5nKklLDg8INHCo4AoLGWWY8x2eYakoLKmLv2IToZU4wrD1Qn+g3ZR5BSWnRUNvulYHP6SfVUMRdERi273LsPxRIKJfZdMwNf/u3K0Z1A6MgnuHiKSZXhQlySR4RRnP4xkzPi+9fCptvyHywKgAwmnToK5npJ4i48gXePn4ci24OjSyc1cdZmgx66TbIGtDXSUKe4siunuSiRvIEmo1
  template:
    metadata:
      creationTimestamp: null
      name: dui-config
      namespace: jobs
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  creationTimestamp: null
  name: dui-rclone-config
  namespace: jobs
spec:
  encryptedData:
    rclone.conf: AgBjoMpacPD8FruzytsViJ9wMogktmzCbLX4m1LRHmK4cLPqzEVJbmUZr0e1Xud/cQs9m55MJQDt4NpncIyUbhU6scDzG3COnyEaAIAlNzuv7iLV1Q8sFjeAxAr4RPieRgjpUy3fWMbXqTPXvYUdtkc6oy09BqA8wo299RiYnOm2n1h5GwFfleERHSQ6n7hK8Q29O5LdWKlIKqQie6VPYonZlEF/qIhYQgQHeR72xk9Trwrt7d8UKQofbJ5ipqfEcnBs83daEX3pZkehlO4wFsSF2iDoAmDoU8zHidpB0/Q7MJ0C51aeVo4XwZaqmFJQzkEVnlLNeIgt6qhS4JkZSK3U/zC4fFTFPEPyA1FLrLQUgEe2/RPIz2EyymbXV3cAiW/lNCsY7lfyVZo0D45OfELBZ6Da9CAMmZOcpKiDlYpP6Y59qxnu+iFo64yxvja76wddGnp4VG5WEPpWOe/FOefjSYj47Kw828YL9orhJ8xj1yeHUMijyxYpWXuwW4qiWaMWiS05NHD4Fx0RxOW2sEPGXakB8w3vunEHVKQ7nOerhQQUXmkzBeDOWtGBCj4TZTwgYWRb7yKMzw+HgwgrTP0GXshjHXcI5hCaPa0S5nDGnMrjcH6bmrPB49VokKpuYBv0T1+qPTDpy6lenM+U0sS0tWQjJxYruF2xe/awZ1AXYXqDgaAEqaG4WceNUCVk+W7Zua75pcpJVUwZxqJDYt6K4eFnuuyGgOSZopFA8Cv80eanKZpaVUe72f3LWcgNtYvExXTJv+K1AeLii95mrHWrHx9kiF65c04lIlaycPW3s/VrP4Q9oOJjhLXx8PR9GYrmckmDBK0m5gqZsj0RP3yOTfXxkaVmEHo6vcmb5ZqYDxZTN3rFxnSK0jxtETEE6EdUzSe86ZVX9+0Iu+xUvsgbRmbn0yXcOKulqZnIwQYYkMHR
  template:
    metadata:
      creationTimestamp: null
      name: dui-rclone-config
      namespace: jobs
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: dui-cache-clear
  namespace: jobs
spec:
  schedule: '0 0 * * 0'  # at 00:00 on Sunday
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          volumes:
          - name: dui
            iscsi:
              iqn: iqn.2014-09.com.radoncanyon:nas1:dui
              targetPortal: 192.168.220.149
              lun: 1
              fsType: ext4
          containers:
          - name: dui
            image: nlopez/dui:4
            command: ["sh"]
            args: ["-c" , "rm -rfv /dui/*"]
            volumeMounts:
            - name: dui
              mountPath: /dui
          restartPolicy: Never
