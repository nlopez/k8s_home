apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: dui
  namespace: jobs
spec:
  schedule: '12 */1 * * *'
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          volumes:
          - name: dui
            iscsi:
              iqn: iqn.2014-09.com.radoncanyon:nas1:dui
              targetPortal: 192.168.220.149
              lun: 1
              fsType: ext4
          - name: dui-config
            secret:
              secretName: dui-config
          - name: dui-rclone-config
            secret:
              secretName: dui-rclone-config
          initContainers:
          - name: dui
            image: nlopez/dui:4
            env:
              - name: DUI_INI
                value: /dui/config/dui.ini
            volumeMounts:
            - name: dui
              mountPath: /dui
            - name: dui-config
              mountPath: /dui/config
              readOnly: true
          - name: rclone
            image: rclone/rclone:1.50.2
            args:
            - --config
            - /config/rclone.conf
            - copy
            - --progress
            - /dui/data
            - Nextcloud:/dui
            volumeMounts:
            - name: dui
              mountPath: /dui
              readOnly: true
            - name: dui-rclone-config
              mountPath: /config
              readOnly: true
          containers:
          - name: hc-ping
            image: buildpack-deps:bionic-curl
            command: ["/usr/bin/curl"]
            args:
            - --retry
            - '3'
            - https://hc-ping.com/4bb27667-5f75-46ed-ac59-a1a04dd54008
          restartPolicy: Never
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  creationTimestamp: null
  name: dui-config
  namespace: jobs
spec:
  encryptedData:
    dui.ini: AgCQNPLJPHeiW8evJLWGehzuDfswsdzVmZh6kjEttTD3qQ9yl9nUAiTgXCNUO7uigxcQmDW9jZYTp9GDBewkIn8nitxmIy+cVKWPNHXMVvcbntASCFTk68ifwQcyi1/u0EKQ3uzYHKbkkaLiPgAICl78Y7t+f2ne1/Gfzly4s5TMT3NV8s0lMIP1Ioj7HV4/cXMhkwU7uPJTLL/eUv/GZVqpsyfCmzmKtdk3sHba/t3GnFkWamwz0hnrFKqt5MtLehldARErhB+o9xxUSLq5/a8Y6fMGH9Q0FDfRBhYnD4A25I+TQlu7jmnAQS9bz13oMsUTaFTYRL680yqxrOWm5RNdip8M1Wg7TGANonrWo+wWgXjZJY1xRmWSC+oN8q+xDNnhS664MY3KvT+jC/v78kgPLWoc/xDTZ8RCd6Sfl4xGJvpk3OMJDZoB9Mi2o6ot4WuywXYWqg70gLfrKrU6wKV28y9RueX30K4MknopEmUyFfBAVU1rL5RDjBa0/sS+wCGG4v6CsHUa96uGjWcutCbTrJGcKSYfEMRuAGoypzxdLLbldtR90tz0JPL+H1qJQ+LzkFIZ0unlYL3AS866A/qxdPrVRYquQWSyo14L0qT3/x0ZN/roF2sprrJrIM5WXJ0hFRRwT1VmXJSWFRhw1we64nAtIUCmfUNO9dCkz3H23yU0+mv9xf7i48ID9ju45Kregf4vy/HhS6/ql8skHNVoRmSPLzZbp9fHFkAqvU36VNZ74drFec3QnsXnl78dKLR9EPvxRm4WMZQp8ZXRdaG9TTpaekjaTUeGkVAz8MatdBzUhg94IJVSz2zu+7Ag1qxetdrbUfKQ7/ZvQ/OG2WOHlnbYqzAoWxYNp5dz5TUnqzrLLyo6mnBDP1bmnRSRqOqAn2q+8k8d+LLkadP/g9VRU+d6qXpwPZFchmK1ikURgfxJgvqLXOUdaSiLwDV485BNDPXnO3mqv6MMCtOhGj3tzYhBtoa/C+E5Ht+DEqcMigHdnGt8k8ndNqafIiJO6zn7G25L8eXLYC9E4QHI0fTEiq5nKklLDg8INHCo4AoLGWWY8x2eYakoLKmLv2IToZU4wrD1Qn+g3ZR5BSWnRUNvulYHP6SfVUMRdERi273LsPxRIKJfZdMwNf/u3K0Z1A6MgnuHiKSZXhQlySR4RRnP4xkzPi+9fCptvyHywKgAwmnToK5npJ4i48gXePn4ci24OjSyc1cdZmgx66TbIGtDXSUKe4siunuSiRvIEmo1
  template:
    metadata:
      creationTimestamp: null
      name: dui-config
      namespace: jobs
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  creationTimestamp: null
  name: dui-rclone-config
  namespace: jobs
spec:
  encryptedData:
    rclone.conf: AgB57fbmKfEXKHwTNNWmalI7fW+L5pV0oAJdIhL+jTkOjYKd9qzk1b4aoIYDhscSltWAVgGpqfCSJxLtuCldVN/PCEsWmLEzJiqAOXoRvGfFGX91JY9NH5b9ANkexoUi7ZkvMbaeV3dkbHtsbntqZcmowZ+2dkwNMxHBXtoEYgHSwGDffbK7762C7zOL8mh4g0ZcYVRu3VxxrKD/4+xmx+SbBKHEbL7R/FMoO4yR6TqWc3D300YNFrISGPP9z9rW+aXh1kkHXYPB1CyMtAuYerBAtqhgSuISwYiYClcyF/6ZhTo2jWa23GZgpc6/9FIPJ0Y8FqQc4VmECC6dCCP++zvSJ0TKI/QaQ3NTaPfFC9++K1XRh2mYda7PD0RVHtrrQ1XPXOUiC1fM60IjluI75m0ha8Qtdl/8I1dD6Ud/V9DH2yBbWenI5mmy7cyA/uoCXSzJNPvJ5am7VjBkAb3U2KJ1VqCuafxP687WTw3Mx9CCZLtEzOgMEc5taO45PHBfq3UMs89r/atNKoVdCrgOZGZi4EiYBMF5ICHammzoy5iwtCV2uY5RPs3WFGhfhAYxweeBmzVHpIvb+HFuLlpFPAQ1N8n4zp7XZ7yZULKdUau7T1l+tFuTwBr1Azl4r55DUl0Lcu08PB9pCrw5R6/LAlpVsM95FK/PMbpDrsSoXsXD0CZXj3R8bvGrk3A1zhXElPjs8ZETwS/vKwuhtK8fjTAwP6i2sA4pp/uWzjTA87E4XrSP51rprrYFfSJ8TODV0SKDpLFYiTP7tIoIpHC1XgNHSizy7zZ0oj1U5tZLgAdcOdo/1Q+5U9CKcU9jlNWo+VWo5So0+rXlkL3wqiwuKcMGFuUMGEQ63jN5gcJYZOCRKShD/XMksLB9dRA/SAnecpunVx9ok1LKT/aKz+dKlgwiTnYtU6hxFDxH9vLsF4YAxlo=
  template:
    metadata:
      creationTimestamp: null
      name: dui-rclone-config
      namespace: jobs
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: dui-cache-clear
  namespace: jobs
spec:
  schedule: '0 0 * * 0'  # at 00:00 on Sunday
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          volumes:
          - name: dui
            iscsi:
              iqn: iqn.2014-09.com.radoncanyon:nas1:dui
              targetPortal: 192.168.220.149
              lun: 1
              fsType: ext4
          containers:
          - name: dui
            image: nlopez/dui:4
            command: ["sh"]
            args: ["-c" , "rm -rfv /dui/*"]
            volumeMounts:
            - name: dui
              mountPath: /dui
          restartPolicy: Never
